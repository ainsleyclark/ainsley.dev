<!-- =====================
    Picture
		partial "media/picture.html" (dict "global" . "url" "/images/hello.jpg" "lazy" true "mobile" false "class" "class-name" "id" "id-name")
		- global:			The global context, this has to be parsed or an error will be thrown.
		- url:				The relative URL of the resource/image, this has to be parsed or an error will be thrown.
		- lazy:				If the image should be lazy loaded, defaults to false.
		- [css-key] bool:	Hide a particular viewport by outputting a 1px dot. See .Params for the css keys.
    ===================== -->
{{ $showAvifWebp := ne hugo.Environment "development" -}}
{{ if isset $ "global" -}}
    {{ if .url }}
        {{- $resource := resources.Get .url -}}
		{{ if eq $resource nil -}}
			{{- $resource = .global.Resources.Get .url -}}
		{{- end -}}
        {{ if $resource -}}
			<!-- Container Sizes -->
			{{ range $key, $size := .global.Site.Params.css.container -}}
				{{ if gt $resource.Width $size -}}
					{{- $image := $resource.Resize (printf "%dx" $size) -}}
					{{ $show := true }}
					{{ if and (eq (isset $ $key) true) (eq (index $ $key) false) -}}
						<!-- 1px Dot -->
						<source media="(max-width:{{ $size }}px)" sizes="1px"
								srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/>
					{{- else -}}
						{{ if $showAvifWebp -}}
							{{- $noExtension := strings.TrimSuffix (path.Ext $image.RelPermalink) $image.RelPermalink -}}
							<!-- AVIF -->
							<source media="(max-width: {{ $size }}px)" {{ if $.lazy }} class="lazy lazy-hide"
									data-{{ end }}srcset="{{ $noExtension }}.avif" type="image/avif"/>
							<!-- WebP -->
							<source media="(max-width: {{ $size }}px)" {{ if $.lazy }} class="lazy lazy-hide"
									data-{{ end }}srcset="{{ $noExtension }}.webp" type="image/webp"/>
						{{- end }}
						<!-- Original -->
						<source media="(max-width: {{ $size }}px)" {{ if $.lazy }} class="lazy lazy-hide"
								data-{{ end }}srcset="{{ $image.RelPermalink }}"/>
					{{- end }}
				{{- end }}
			{{- end }}
			<!-- Original - AVIF/WebP -->
			{{ if $showAvifWebp -}}
				{{ $noExtension := strings.TrimSuffix (path.Ext $resource.RelPermalink) $resource.RelPermalink }}
				<!-- AVIF -->
				<img {{ if .lazy }} class="lazy lazy-hide"
					data-{{ end }}src="{{ $noExtension }}.avif"
					alt="{{ with .alt -}} {{ . }} {{- end }}"
					type="image/avif"
					width="{{ $resource.Width}}" height="{{ $resource.Height }}"/>
				<!-- WebP -->
				<img {{ if .lazy }} class="lazy lazy-hide"
					data-{{ end }}src="{{ $noExtension }}.webp"
					alt="{{ with .alt -}} {{ . }} {{- end }}"
					type="image/webp"
					width="{{ $resource.Width}}" height="{{ $resource.Height }}"/>
			{{- end }}
			<!-- Original - Image -->
			<img {{ if .lazy }} class="lazy lazy-hide"
				data-{{ end }}src="{{ $resource.RelPermalink }}"
				alt="{{ with .alt -}} {{ . }} {{- end }}"
				width="{{ $resource.Width}}" height="{{ $resource.Height }}"
			/>
			<!-- NoScript -->
			{{ if .lazy -}}
				<noscript>
					<img src="{{ $resource.RelPermalink }}" alt="{{ with .alt -}} {{ . }} {{- end }}"
						 width="{{ $resource.Width}}" height="{{ $resource.Height }}"/>
				</noscript>
			{{- end }}
        {{- else -}}
            {{ warnf "Image not found with url: %s" .url }}
        {{- end }}
    {{- else -}}
        {{ errorf "No image url attached to picture element" }}
    {{- end }}
{{- else -}}
    {{ errorf "'global' variable should be passed to the <picture> partial" }}
{{- end }}
